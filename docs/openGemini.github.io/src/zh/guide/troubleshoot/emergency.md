---
title: 应急修复指南
order: 3
---


# 应急修复指南

针对于一些应急场景下，集群难以自愈，需要采取人工的手段进行修复



## 元数据文件损坏

在meta进程的元数据文件由于磁盘等原因导致文件损坏，如果恰好这时meta进程还在运行中，这时候可以通过对meta进行快照修复

假设meta的三个节点Ip为**172.16.4.76**、**172.16.8.65**、**172.16.27.77**

### 执行快照

分别执行

**curl -i -XPOST 'http://172.16.4.76:8091/userSnapshot?version=2';echo ''**

**curl -i -XPOST 'http://172.16.8.65:8091/userSnapshot?version=2';echo ''**

**curl -i -XPOST 'http://172.16.27.77:8091/userSnapshot?version=2';echo ''**

只要有一个节点返回ok就行，如果三个都还在，都返回ok，更好

### 检查快照

cd meta/{x}/snapshots

通过时间戳判断，查看快照文件是否存在

### 停止集群

通过命令行或者管控，将openGemini集群进程停止

删除有损坏的meta文件

### 启动集群

通过命令行或者管控，将openGemini集群进程重新启动

集群即可恢复

该方法也适用于元数据备份恢复场景。比如升级前备份，回退的时候做恢复；或者由于运维人员误操作，导致元数据文件损坏，做紧急修复；或者某些实验场景，需要在异地重建集群做相关测试，不影响现网集群



## 索引文件损坏

openGemini的索引和数据文件有对应的关系，如下示例，2_1760918400000000000_1761523200000000000_2是数据路径，2_1760918400000000000_1761523200000000000_2是索引路径，两者是有明显的对应关系

```
# pwd
/tmp/openGemini/data/data
# cd yy/1/autogen/
# ll
drwxr-x--- 3 root root 4096 Oct 23 17:08 2_1760918400000000000_1761523200000000000_2
drwxr-x--- 3 root root 4096 Oct 23 17:08 index
# cd index/
# ll
drwxr-x--- 3 root root 4096 Oct 23 17:08 2_1760918400000000000_1761523200000000000
```

在一些场景下，可能存在索引/数据文件损坏；或者索引/数据文件需要迁移到其他环境做测试或者复现；甚至由于磁盘即将爆盘，需要将部分索引数据临时迁移走

### 迁移索引/文件

#### 停止集群

通过命令行或者管控，将openGemini集群进程停止

移走索引和数据文件，记录对应的数据路径。如果只是迁移数据到其他环境做测试，复制即可

#### 启动集群

通过命令行或者管控，将openGemini集群进程重新启动

集群即可恢复，移走的数据和索引将不可查询



### 恢复索引/文件

#### 停止集群

通过命令行或者管控，将openGemini集群进程停止

将索引和数据，按照之前记录对应的数据路径，迁移回原始路径上

#### 启动集群

通过命令行或者管控，将openGemini集群进程重新启动

集群即可恢复，数据恢复查询



## 元数据强制更新

一些场景下，元数据可能需要做强制更新。比如有一个集群，没有使用域名通信，集群内配置的ip通信，由于一些原因，比如更换机器等，需要更换机器的ip。这时就需要强制更新元数据。还有一种场景，现网有一个集群，想把现网的数据导出一份到线下去测试，逻辑备份太慢，就可以通过物理备份，但是由于ip记录在元数据中，线下重新搭建集群的时候，除非使用和现网一样的ip配置，否则集群无法正常运行。（使用域名就没有这样的问题）



### 停止业务

为了防止在强刷元数据时，同时有元数据在被修改。故需要先停止业务，如果没有业务的开关，可以先停止ts-sql或者ts-data/ts-store进程



### 更新元数据

刷新元数据，命令如下，需要对所有的meta都执行一次

curl -i -XPOST "http://{metaip}:8091/forceMetaData" --data-binary '{元数据}'

刷新前，可以先做元数据的备份，命令如下

curl http://{metaip}:8091/getdata



### 重启集群

停止所有openGemini进程

先拉起ts-meta进程，再拉起其他进程











